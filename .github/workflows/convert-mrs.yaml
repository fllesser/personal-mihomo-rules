name: Build and Convert Ruleset

on:
  push:
    branches: [main]

jobs:
  convert-ruleset:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许工作流写入仓库内容（包括管理 Release）

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download and extract mihomo
        run: |
          # 下载mihomo二进制文件
          curl -L -o mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/mihomo-linux-amd64-alpha-7e9e12c.gz"
          # 解压文件
          gunzip mihomo.gz
          chmod +x mihomo

      - name: Convert ruleset
        run: |
          # 执行规则集转换
          ./mihomo convert-ruleset domain yaml direct.yaml direct.mrs
          ./mihomo convert-ruleset domain yaml proxy.yaml proxy.mrs
          ./mihomo convert-ruleset domain yaml hkban-proxy.yaml hkban-proxy.mrs
          ./mihomo convert-ruleset domain yaml reject.yaml reject.mrs

      - name: Get current time
        uses: josStorer/get-current-time@v2.1.2 # 使用 Action 获取当前时间
        id: current-time # 为此步骤设置一个ID，便于后续引用
        with:
          format: YYYY-MM-DD HH:mm:ss # 指定时间格式，遵循 Moment.js 语法
          utcOffset: "+8" # 可选，设置UTC偏移，例如东八区

      - name: Update Release (Replace Assets)
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true # 允许更新现有Release
          tag: "v1.0.0" # 指定你要更新的Release的标签
          name: "${{ steps.current-time.outputs.formattedTime }}" # Release的名称
          draft: false # 明确指定为非草稿
          prerelease: false # 明确指定为非预发布
          artifacts: "*.mrs" # 上传所有.mrs文件
          body: "Automatically updated ruleset, Generated from commit ${{ github.sha }}."
          token: ${{ secrets.GITHUB_TOKEN }}
          